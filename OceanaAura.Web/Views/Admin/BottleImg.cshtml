@{
    Layout = "../Shared/_AdminLayout.cshtml";
    var Sizes = ViewBag.Sizes as List<OceanaAura.Web.Models.Size.SizeVM>;
    var Colors = ViewBag.Colors as List<OceanaAura.Web.Models.Colors.ColorVM>;
    var Products = ViewBag.Products as List<OceanaAura.Web.Models.Products.ProductVMHome>;
}

<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="w-100">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Bottle Images</h1>
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <a asp-action="AddBottleImg" asp-controller="Admin" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
                <i class="fas fa-plus fa-sm text-white-50"></i> Add Bottle Image
            </a>
            <button id="deleteAllBottles" class="d-none d-sm-inline-block btn btn-sm btn-danger shadow-sm ms-2">
                <i class="fas fa-trash fa-sm text-white-50"></i> Delete All Bottles
            </button>
        </div>
    </div>
    <hr />

    <!-- DataTable -->
    <table id="bottleImgTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
        <thead>
            <tr>
                <th>Image URL</th>
                <th>Size</th>
                <th>Color</th>
                <th>Lid</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

@section ScriptsAuth {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function () {
            // Initialize DataTable
            var table = $('#bottleImgTable').DataTable({
                "serverSide": true,
                "processing": true,
                "searching": false,
                "ajax": {
                    "url": "@Url.Action("GetAllBottleImg", "Admin")",
                    "type": "POST",
                    "datatype": "json",
                },
                "columns": [
                    {
                        "data": "imgUrlFront",
                        "name": "ImgUrlFront",
                        "autoWidth": true,
                        "render": function (data, type, row) {
                            return `<img src="/File/ColorsImg/${data}" loading="lazy" alt="Bottle Image" width="50" loading="lazy" height="50" />`;
                        }
                    },
                    {
                        "data": "sizeId",
                        "name": "SizeId",
                        "autoWidth": true,
                        "render": function (data, type, row) {
                            var sizes = @Html.Raw(Json.Serialize(Sizes));
                            var size = sizes.find(s => s.id === data);
                            return size ? size.nameEn : "Unknown Size";
                        }
                    },
                    {
                        "data": "colorId",
                        "name": "ColorId",
                        "autoWidth": true,
                        "render": function (data, type, row) {
                            var colors = @Html.Raw(Json.Serialize(Colors));
                            var color = colors.find(c => c.id === data);
                            return color ? color.nameEn : "Unknown Color";
                        }
                    },
                    {
                        "data": "lidId",
                        "name": "LidId",
                        "autoWidth": true,
                        "render": function (data, type, row) {
                            var products = @Html.Raw(Json.Serialize(Products));
                            var product = products.find(p => p.id === data);
                            return product ? product.name : "Unknown Lid";
                        }
                    },
                    {
                        "data": null,
                        "orderable": false,
                        "render": function (data, type, row) {
                            return `
                                <a href="#" class="delete-bottle-img btn btn-sm btn-danger ms-2" data-id='${row.id}' data-img-urlfront='${row.imgUrlFront}' data-img-urlback='${row.imgUrlBack}'>
                                    <i class="fas fa-trash"></i>
                                </a>
                            `;
                        }
                    }
                ],
                "order": [[0, 'asc']],
                "pageLength": 10
            });

            // Delete functionality
            $(document).on('click', '.delete-bottle-img', function (e) {
                e.preventDefault();
                var bottleImgId = $(this).data('id');
                var imgUrlfront = $(this).data('img-urlfront');
                var imgUrlback = $(this).data('img-urlback');

                Swal.fire({
                    title: 'Are you sure?',
                    text: 'You won\'t be able to revert this!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'No, keep it'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '@Url.Action("DeleteBottleImg", "Admin")',
                            type: 'POST',
                            data: {
                                id: bottleImgId,
                                imgUrlFront: imgUrlfront,
                                imgUrlBack: imgUrlback
                            },
                            success: function (response) {
                                if (response.success) {
                                    $('#bottleImgTable').DataTable().ajax.reload();
                                    Swal.fire('Deleted!', response.message, 'success');
                                } else {
                                    Swal.fire('Error!', response.message, 'error');
                                }
                            },
                            error: function () {
                                Swal.fire('Error!', 'An error occurred while deleting the bottle image.', 'error');
                            }
                        });
                    }
                });
            });

            // Delete All Bottles functionality
            $(document).on('click', '#deleteAllBottles', function (e) {
                e.preventDefault();

                Swal.fire({
                    title: 'Are you sure?',
                    text: 'This will delete ALL bottle images and cannot be undone!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete all!',
                    cancelButtonText: 'No, cancel',
                    confirmButtonColor: '#d33',
                    dangerMode: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '@Url.Action("DeleteAllBottleImg", "Admin")',
                            type: 'POST',
                            success: function (response) {
                                if (response.success) {
                                    $('#bottleImgTable').DataTable().ajax.reload();
                                    Swal.fire('Deleted!', response.message, 'success');
                                } else {
                                    Swal.fire('Error!', response.message, 'error');
                                }
                            },
                            error: function () {
                                Swal.fire('Error!', 'An error occurred while deleting all bottle images.', 'error');
                            }
                        });
                    }
                });
            });
        });
    </script>
}