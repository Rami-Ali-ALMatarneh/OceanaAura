@namespace OceanaAura.Web.Models.BuyVM
@model OceanaAura.Web.Models.BuyVM.OrderDetails

@{
    var sizes = (List<OceanaAura.Web.Models.Size.SizeVM>)ViewBag.Sizes;
    var SelectedRegionPage = ViewBag.SelectedRegionPage;
    var Lids = (List<OceanaAura.Web.Models.BuyVM.LidsVM>)ViewBag.Lids;
    var CartSummaryList = ViewBag.CartSummaryList as List<OceanaAura.Web.Models.BuyVM.OrderSummary>;
    var SelectedLanguage = ViewBag.SelectedLanguage;
    var colors = (List<OceanaAura.Web.Models.Colors.ColorVM>)ViewBag.Colors;
}

<!-- Add Evil Empire Font CDN -->
<link href="https://fonts.cdnfonts.com/css/evil-empire" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="~/css/arabicLang.css">

<style>
    /* Custom CSS for the spinner */
    .spinner-border {
        width: 5rem;
        height: 5rem;
        border: 1em solid black;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border 0.75s linear infinite;
    }

    @@keyframes spinner-border {
        to {
            transform: rotate(360deg);
        }
    }

    /* Main Container */
    .container-fluid {
        padding: 0 15px;
    }

    /* Design Card Container */
    .design-card-container {
        position: relative;
        width: 100%;
        height: 500px; /* Fixed height for consistency */
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
    }

    .design-image-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .design-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .design-text-overlay {
        position: absolute;
        bottom: 70px; /* Position from bottom */
        left: 0;
        width: 100%;
        text-align: center;
        color: silver;
        font-size: 22px;
        pointer-events: none;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Better visibility */
        word-wrap: break-word;
        white-space: pre-line;
        margin: 0 auto;
        line-height: 1.3;
    }

    /* Color Selection */
    .color-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        background-size: cover;
        background-position: center;
        margin: 5px;
        border: 2px solid transparent;
        transition: all 0.3s;
    }

        .color-circle.selected {
            border-color: #000;
            transform: scale(1.1);
        }

        .color-circle.sold-out {
            opacity: 0.5;
            position: relative;
            cursor: not-allowed;
        }

            .color-circle.sold-out::after {
                content: "X";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: red;
                font-weight: bold;
                font-size: 20px;
            }

    /* Front Image Box */
    .front-image-box {
        border: 2px solid #000;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        cursor: pointer;
        height: 150px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

        .front-image-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

    /* Form Elements */
    .form-select, .form-control {
        border-radius: 8px;
        padding: 10px 15px;
        border: 1px solid #ced4da;
    }

    /* Buttons */
    .btn {
        border-radius: 8px;
        padding: 10px 15px;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }

        .btn-primary:hover {
            background-color: #0069d9;
            border-color: #0062cc;
        }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }

    /* Lids Cards */
    .lids-container {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
        gap: 10px;
    }

    .lid-card {
        flex: 1 0 calc(25% - 10px);
        min-width: 100px;
        max-width: 150px;
        aspect-ratio: 3/4;
        cursor: pointer;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 8px;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        background-color: white;
    }

        .lid-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .lid-card.selected {
            border: 2px solid #000;
            background-color: #f8f9fa;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .lid-card img {
            width: 100%;
            height: auto;
            flex-grow: 1;
            object-fit: contain;
            margin-bottom: 5px;
        }

        .lid-card .lid-name {
            font-size: 0.8rem;
            text-align: center;
            margin-bottom: 3px;
            word-break: break-word;
            font-weight: 500;
        }

        .lid-card .lid-price {
            font-size: 0.7rem;
            text-align: center;
            color: #666;
        }

    /* Card Styles */
    .card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .card-body {
        padding: 20px;
    }

    /* Responsive adjustments */
    @@media (max-width: 992px) {
        .lid-card {
            flex: 1 0 calc(33.333% - 10px);
        }
        
        .design-text-overlay {
            font-size: 20px;
        }
    }

    @@media (max-width: 768px) {
        .design-card-container {
            height: 400px;
        }

        .design-text-overlay {
            bottom: 50px;
            font-size: 18px;
        }

        .lid-card {
            flex: 1 0 calc(50% - 10px);
        }

        .front-image-box {
            display: none;
        }

        .show-front-image-btn {
            display: block;
            margin-bottom: 20px;
        }

        .col-md-9 {
            order: -1;
            margin-bottom: 20px;
        }
    }

    @@media (max-width: 576px) {
        .design-card-container {
            height: 350px;
        }

        .design-text-overlay {
            bottom: 40px;
            font-size: 16px;
        }

        .lid-card {
            flex: 1 0 calc(50% - 10px);
            min-width: 80px;
        }
    }

    @@media (min-width: 769px) {
        .show-front-image-btn {
            display: none;
        }
    }

    /* Arabic specific styles */
    .arabic-text {
        font-family: 'DecoType-Thuluth-II', sans-serif;
        direction: rtl;
    }
</style>

<div class="container-fluid mt-4">
    <div class="row w-100 h-100 p-3">
        <!-- Left Sidebar -->
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <!-- Size Selection -->
                    <div class="mb-4">
                        <h4 class="h6">@(SelectedLanguage == "ar" ? "اختر حجم " : "Select Bottle Size")</h4>
                        <select id="size-select" class="form-select">
                            @foreach (var size in sizes)
                            {
                                <option value="@size.Id">@(SelectedLanguage == "ar" ? size.NameAr : size.NameEn)</option>
                            }
                        </select>
                    </div>

                    <!-- Color Selection -->
                    <div class="mb-4">
                        <h4 class="h6">@(SelectedLanguage == "ar" ? "اختر لون " : "Select Bottle Color")</h4>
                        <div class="d-flex flex-wrap gap-3">
                            @foreach (var color in colors)
                            {
                                <label class="color-circle @(color.IsSoldOut ? "sold-out" : "")"
                                       style="background-image: url('/File/ColorsImg/@color.ImageURL');">
                                    <input type="radio" name="ColorId" value="@color.Id"
                                           class="d-none"
                                           @(color.IsSoldOut ? "disabled" : "") />
                                </label>
                            }
                        </div>
                    </div>

                    <!-- Lid Selection -->
                    <div class="mb-4">
                        <h4 class="h6">@(SelectedLanguage == "ar" ? "اختر الغطاء" : "Select Your Lid")</h4>
                        <div class="lids-container">
                            @foreach (var lid in Lids)
                            {
                                <label class="lid-card" data-lid-id="@lid.Id">
                                    <img src="~/File/ColorsImg/@lid.ProductImages" alt="@lid.Name" loading="lazy" />
                                    <div class="lid-name">@lid.Name</div>
                                    <div class="lid-price">
                                        @if (lid.IsMagneticLid)
                                        {
                                            if (SelectedRegionPage == "Jordan")
                                            {
                                                <span>@lid.PriceJOR JOD</span>
                                            }
                                            else if (SelectedRegionPage == "United Arab Emirates")
                                            {
                                                <span>@lid.PriceUAE AED</span>
                                            }
                                        }
                                        else
                                        {
                                            <span>Free</span>
                                        }
                                    </div>
                                    <input type="radio" name="LidId" value="@lid.Id" style="display: none;" />
                                </label>
                            }
                        </div>
                    </div>

                    <!-- Button to show front image on mobile -->
                    <div class="mb-4 show-front-image-btn">
                        <button id="show-front-image" class="btn btn-secondary w-100">@(SelectedLanguage == "ar" ? "عرض الصورة الأمامية" : "Show Front Image")</button>
                    </div>

                    <!-- Front Image Box -->
                    <div class="mb-4 front-image-box">
                        <img id="front-image" src="" alt="Front Image" loading="lazy" style="display: none;">
                    </div>

                    <!-- Font Selection -->
                    <div class="mb-4">
                        <h4 class="h6">@(SelectedLanguage == "ar" ? "اختر الخط" : "Select Your Font")</h4>
                        <select id="font-select" class="form-select">
                            <option value="">@(SelectedLanguage == "ar" ? "اختر الخط" : "Select Your Font")</option>
                            <option value="Evil Empire">Evil Empire (English)</option>
                            <option value="DecoType-Thuluth-II">DecoType-Thuluth-II (عربي)</option>
                        </select>
                    </div>

                    <!-- Add Text Section -->
                    <div class="mb-4">
                        <h4 class="h6">@(SelectedLanguage == "ar" ? "إضافة نص" : "Add Text")</h4>
                        <input type="text" id="text-input" class="form-control mb-4" placeholder="@(SelectedLanguage == "ar" ? "أدخل النص (من 2 إلى 20 أحرف)" : "Enter text (2 to 20 characters)")" maxlength="20">
                    </div>

                    <!-- Make Order Button -->
                    <div class="mb-4">
                        <button id="make-order" class="btn btn-primary w-100">@(SelectedLanguage == "ar" ? "تقديم الطلب" : "Place Order")</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Design Card Area -->
        <div class="col-md-9">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="design-card-container">
                        <div class="design-image-wrapper">
                            <img id="design-image" class="design-image" src="" alt="Design Image" loading="lazy" />
                            <div id="design-text" class="design-text-overlay"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Spinner -->
<div id="spinner" class="spinner-border text-primary" role="status" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
    <span class="visually-hidden">Loading...</span>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function () {
        // Initialize variables
        let currentFont = 'Evil Empire';
        let currentText = '';
        let isArabic = false;
        
        // Default images for each size in order of selection index
        const defaultImages = [
            '/File/HomeImg/Artboard350.svg',    // First option (index 0)
            '/File/HomeImg/OriginalLid650.svg',   // Second option (index 1)
            '/File/HomeImg/OriginalLid750.svg',   // Third option (index 2)
            '/File/HomeImg/OriginalLid1L.svg',    // Fourth option (index 3)
            '/File/HomeImg/OriginalLid12.svg'    // Fifth option (index 4)
        ];
        
        // Load default bottle image based on selected size index
        function loadDefaultImage() {
            const selectedIndex = $('#size-select')[0].selectedIndex;
            const defaultImage = defaultImages[selectedIndex] || '/File/HomeImg/Artboard350.svg';
            $('#design-image').attr('src', defaultImage);
        }
        
        // Initial load
        loadDefaultImage();
        
        // Update default image when size changes
        $('#size-select').change(function() {
            loadDefaultImage();
        });
        
        // Function to show alert message
        function showAlert(arMessage, enMessage) {
            const selectedLanguage = '@SelectedLanguage';
            const message = selectedLanguage === 'ar' ? arMessage : enMessage;
            const confirmButtonText = selectedLanguage === 'ar' ? 'حسناً' : 'OK';

            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: message,
                confirmButtonText: confirmButtonText
            });
        }
        
        // Function to update bottle image
        function updateBottleImage() {
            const sizeId = $('#size-select').val();
            const colorId = $('input[name="ColorId"]:checked').val();
            const lidId = $('input[name="LidId"]:checked').val();

            // Validate if size, color, and lid are selected
            if (!sizeId || !colorId || !lidId) {
                return;
            }

            // Show the spinner
            $('#spinner').show();

            // Make an AJAX request to fetch the filtered bottle image
            $.ajax({
                url: '/Home/GetFilteredBottleImg',
                type: 'GET',
                data: {
                    sizeId: sizeId,
                    colorId: colorId,
                    lidId: lidId
                },
                success: function (data) {
                    const baseUrl = '/File/ColorsImg/';

                    // Display the front image in the box
                    if (data.imgUrlFront) {
                        const frontImageUrl = baseUrl + data.imgUrlFront;
                        $('#front-image').attr('src', frontImageUrl).show();
                    }

                    // Display the back image on the card
                    if (data.imgUrlBack) {
                        const backImageUrl = baseUrl + data.imgUrlBack;
                        $('#design-image').attr('src', backImageUrl).on('load', function() {
                            // Update text after image loads
                            updateText();
                            $('#spinner').hide();
                        });
                    }
                },
                error: function (xhr, status, error) {
                    // Hide the spinner in case of an error
                    $('#spinner').hide();
                    showAlert('المنتوج غير متوفر في المخزون!', 'Product is out of stock!');
                }
            });
        }
        
        // Function to update text
        function updateText() {
            if (currentText) {
                // Split text into two lines if it contains a space
                let displayText = currentText;
                if (currentText.includes(' ')) {
                    const words = currentText.split(' ');
                    if (words.length > 1) {
                        // Join first half and second half with new line
                        const mid = Math.ceil(words.length / 2);
                        displayText = words.slice(0, mid).join(' ') + '\n' + words.slice(mid).join(' ');
                    }
                }
                
                $('#design-text').text(displayText)
                    .css('font-family', currentFont)
                    .toggleClass('arabic-text', isArabic)
                    .show();
            } else {
                $('#design-text').hide();
            }
        }

        // Live update when size, color or lid changes
        $('#size-select, input[name="ColorId"], input[name="LidId"]').change(function() {
            updateBottleImage();
        });

        // Text input live update
        $('#text-input').on('input', function() {
            currentText = $(this).val();
            updateText();
        });

        // Handle Font Selection from <select> Dropdown
        $('#font-select').change(function () {
            currentFont = $(this).val();
            isArabic = currentFont === 'DecoType-Thuluth-II';
            updateText();
        });

        // Handle click on color circles
        $('.color-circle').on('click', function () {
            if ($(this).hasClass('sold-out')) {
                showAlert('هذا اللون غير متوفر!', 'This color is sold out!');
            } else {
                $('.color-circle').removeClass('selected');
                $(this).addClass('selected');
                updateBottleImage();
            }
        });

        // Handle click on lid cards
        $('.lid-card').on('click', function () {
            $('.lid-card').removeClass('selected');
            $(this).addClass('selected');
            updateBottleImage();
        });

        // Click event for the front image box
        $('.front-image-box').on('click', function () {
            const frontImageUrl = $('#front-image').attr('src');
            if (frontImageUrl) {
                Swal.fire({
                    imageUrl: frontImageUrl,
                    imageAlt: 'Front Image',
                    showCloseButton: true,
                    showConfirmButton: false,
                    width: '70%',
                    backdrop: true,
                });
            } else {
                showAlert('لا توجد صورة لعرضها!', 'No image to display!');
            }
        });

        // Show front image on mobile when button is clicked
        $('#show-front-image').click(function () {
            const frontImageUrl = $('#front-image').attr('src');
            if (frontImageUrl) {
                Swal.fire({
                    imageUrl: frontImageUrl,
                    imageAlt: 'Front Image',
                    showCloseButton: true,
                    showConfirmButton: false,
                    width: '70%',
                    backdrop: true,
                });
            } else {
                showAlert('لا توجد صورة لعرضها!', 'No image to display!');
            }
        });

        // Make Order Button Click Handler
        $('#make-order').click(function () {
            const sizeId = $('#size-select').val();
            const colorId = $('input[name="ColorId"]:checked').val();
            const lidId = $('input[name="LidId"]:checked').val();
            const text = $('#text-input').val();
            const fontFamily = $('#font-select').val();

            // Validate if size, color, and lid are selected
            if (!sizeId || !colorId || !lidId) {
                showAlert('الرجاء تحديد الحجم واللون والغطاء!', 'Please select size, color, and lid!');
                return;
            }

            // Validate text length if exists
            if (text && (text.length < 2 || text.length > 20)) {
                showAlert('النص يجب أن يكون بين 2 و 20 حرفًا!', 'Text must be between 2 and 20 characters!');
                return;
            }

            // Show the spinner
            $('#spinner').show();

            // Prepare the order details object
            const orderDetails = {
                SizeId: sizeId,
                ColorId: colorId,
                LidId: lidId,
                IsCustomize: text ? true : false,
                Text: text,
                FontFamily: fontFamily
            };

            // Send the order details to the server
            $.ajax({
                url: '/Home/OrderRequest',
                type: 'POST',
                data: orderDetails,
                success: function (response) {
                    $('#spinner').hide();
                    if (response.success) {
                        // Redirect to the Order action in the Home controller
                        window.location.href = `@Url.Action("order", "Home")?Details=OrderDetails`;
                    } else {
                        showAlert('فشل في تقديم الطلب!', 'Failed to submit the order!');
                    }
                },
                error: function (xhr, status, error) {
                    $('#spinner').hide();
                    showAlert('فشل في تقديم الطلب!', 'Failed to submit the order!');
                }
            });
        });
    });
</script>